import{a as be}from"./chunk-PZ6CWC4A.js";import"./chunk-LB4NNBHO.js";import{a as _e}from"./chunk-2WRDL5NI.js";import{a as w}from"./chunk-WXOXMQ3X.js";import{K as ve,S as ge,_ as he,a as de,c as ue,h as me,j as pe,u as fe}from"./chunk-TI2PQS3J.js";import"./chunk-JQ3F7U5Y.js";import{A as y,Aa as B,B as t,C as i,D as m,E as N,F as E,G as P,Ga as G,Ha as H,Ia as Q,Ja as J,K as a,M,Oa as K,R as k,Sa as W,Ua as X,Ya as Y,_a as Z,ca as q,db as ee,eb as ie,ga as D,ia as V,ib as te,j as _,jb as oe,k as F,l as x,m as C,n as O,na as g,o as s,oa as z,ob as ne,pa as U,qb as re,r as v,ra as j,s as b,sa as L,sb as ae,ta as A,tb as le,va as $,w as p,wb as ce,x as I,xa as R,xb as se,z as T}from"./chunk-IBAPA63D.js";import"./chunk-XMAMLXFW.js";import"./chunk-EW67HA6M.js";import"./chunk-WXVXXLBH.js";import"./chunk-EFAAWUSX.js";import"./chunk-GLOUZK3F.js";import"./chunk-N4PXAYQ7.js";import"./chunk-4WFVMWDK.js";import"./chunk-M2X7KQLB.js";import"./chunk-2YSZFPCQ.js";import"./chunk-57YRIO75.js";import"./chunk-NMPY7VJP.js";import"./chunk-C5RQ2IC2.js";import"./chunk-42C7ZIID.js";import{h as S}from"./chunk-B4AJQJMI.js";var Se=(n,d)=>d.valor;function xe(n,d){if(n&1&&(t(0,"ion-item")(1,"ion-label",4),a(2,"Tipo de servicio"),i(),m(3,"ion-input",33),i()),n&2){let e=P();s(3),b("value",e.obtenerEtiquetaTipo(e.tipoPreseleccionado))}}function Ce(n,d){if(n&1&&(t(0,"ion-select-option",35),a(1),i()),n&2){let e=d.$implicit;b("value",e.valor),s(),M(" ",e.etiqueta," ")}}function Ee(n,d){n&1&&(t(0,"ion-note",6),a(1,"Selecciona un tipo de servicio"),i())}function Pe(n,d){if(n&1&&(t(0,"ion-item")(1,"ion-label",4),a(2,"Tipo de servicio *"),i(),t(3,"ion-select",34),T(4,Ce,2,2,"ion-select-option",35,Se),i()(),v(6,Ee,2,0,"ion-note",6)),n&2){let e,r=P();s(4),y(r.tiposServicio),s(2),p((e=r.formulario.get("tipoServicio"))!=null&&e.touched&&(!((e=r.formulario.get("tipoServicio"))==null||e.errors==null)&&e.errors.required)?6:-1)}}function Ne(n,d){n&1&&(t(0,"ion-note",6),a(1,"El t\xEDtulo es obligatorio"),i())}function Te(n,d){n&1&&(t(0,"ion-note",6),a(1,"M\xEDnimo 10 caracteres"),i())}function ye(n,d){n&1&&(t(0,"ion-note",6),a(1,"La descripci\xF3n es obligatoria"),i())}function we(n,d){n&1&&(t(0,"ion-note",6),a(1,"M\xEDnimo 20 caracteres"),i())}function Fe(n,d){n&1&&m(0,"ion-spinner",14)}function Oe(n,d){n&1&&(m(0,"ion-icon",36),a(1," Usar mi ubicaci\xF3n actual "))}function Ie(n,d){n&1&&(t(0,"ion-note",15),m(1,"ion-icon",37),a(2," Ubicaci\xF3n obtenida correctamente "),i())}function Me(n,d){if(n&1){let e=N();t(0,"div",18),m(1,"img",38),t(2,"ion-icon",39),E("click",function(){let o=x(e).$index,c=P();return C(c.eliminarFoto(o))}),i()()}if(n&2){let e=d.$implicit;s(),b("src",e,O)}}function ke(n,d){if(n&1){let e=N();t(0,"div",40),E("click",function(){x(e);let o=P();return C(o.agregarFoto())}),m(1,"ion-icon",41),t(2,"span"),a(3,"Agregar"),i()()}}function qe(n,d){n&1&&(t(0,"div",24),m(1,"ion-icon",42),t(2,"span"),a(3,"Las solicitudes de emergencia se env\xEDan a t\xE9cnicos con servicio 24/7"),i()())}function De(n,d){n&1&&m(0,"ion-spinner",14)}function Ve(n,d){n&1&&a(0," Publicar Solicitud ")}var Ye=(()=>{class n{constructor(){this.router=_(V),this.route=_(D),this.fb=_($),this.http=_(q),this.serviciosServicio=_(_e),this.geoServicio=_(be),this.toastCtrl=_(re),this.alertCtrl=_(ne),this.tiposServicio=w,this.fotosPreview=[],this.archivosSeleccionados=[],this.coordenadas=null,this.obteniendoUbicacion=!1,this.enviando=!1,this.fechaMinima=new Date().toISOString().split("T")[0],this.tipoPreseleccionado=null,de({locationOutline:he,cameraOutline:pe,imageOutline:ge,closeCircle:fe,flashOutline:ve,calendarOutline:me,addOutline:ue})}ngOnInit(){this.formulario=this.fb.group({tipoServicio:["",g.required],titulo:["",[g.required,g.minLength(10)]],descripcion:["",[g.required,g.minLength(20)]],direccion:["",g.required],ciudad:["",g.required],estado:["",g.required],referencia:[""],urgencia:["normal",g.required],fechaPreferida:[""],horarioPreferido:["cualquiera"]}),this.route.queryParams.subscribe(e=>{e.tipo&&(this.tipoPreseleccionado=e.tipo,this.formulario.patchValue({tipoServicio:e.tipo}))})}obtenerUbicacion(){return S(this,null,function*(){this.obteniendoUbicacion=!0;let e=yield this.geoServicio.obtenerPosicionActual();e?(this.coordenadas={lat:e.coords.latitude,lng:e.coords.longitude},yield this.obtenerDireccionDesdeCoordenadas(e.coords.latitude,e.coords.longitude),this.mostrarToast("Ubicaci\xF3n obtenida correctamente","success")):this.mostrarToast("No se pudo obtener la ubicaci\xF3n","danger"),this.obteniendoUbicacion=!1})}obtenerDireccionDesdeCoordenadas(e,r){return S(this,null,function*(){try{let o=`https://nominatim.openstreetmap.org/reverse?format=json&lat=${e}&lon=${r}&addressdetails=1&accept-language=es`,c=yield this.http.get(o).toPromise();if(c&&c.address){let l=c.address,u="";l.road&&(u=l.road),l.neighbourhood?u=u?`${l.neighbourhood}, ${u}`:l.neighbourhood:l.suburb&&(u=u?`${l.suburb}, ${u}`:l.suburb);let f=l.city||l.town||l.village||l.municipality||"",h=l.state||l.province||l.region||"";f.toLowerCase().includes("quito")||h.toLowerCase().includes("quito")?(f="Quito",h="Pichincha"):f.toLowerCase().includes("guayaquil")?h="Guayas":f.toLowerCase().includes("cuenca")&&(h="Azuay"),u&&!this.formulario.get("direccion")?.value&&this.formulario.patchValue({direccion:u}),f&&!this.formulario.get("ciudad")?.value&&this.formulario.patchValue({ciudad:f}),h&&!this.formulario.get("estado")?.value&&this.formulario.patchValue({estado:h})}}catch{console.log("No se pudo obtener la direcci\xF3n autom\xE1ticamente")}})}agregarFoto(){let e=document.createElement("input");e.type="file",e.accept="image/*",e.multiple=!0,e.onchange=r=>this.onFotoSeleccionada(r),e.click()}onFotoSeleccionada(e){let r=e.target.files;if(r)for(let o=0;o<r.length&&!(this.fotosPreview.length>=5);o++){let c=r[o];this.archivosSeleccionados.push(c);let l=new FileReader;l.onload=u=>{this.fotosPreview.push(u.target.result)},l.readAsDataURL(c)}}eliminarFoto(e){this.fotosPreview.splice(e,1),this.archivosSeleccionados.splice(e,1)}enviar(){return S(this,null,function*(){if(!this.formulario.valid){this.formulario.markAllAsTouched();return}if(this.enviando=!0,!this.coordenadas){this.mostrarToast("Por favor, obt\xE9n tu ubicaci\xF3n antes de continuar","warning"),this.enviando=!1;return}let e=[this.formulario.value.direccion,this.formulario.value.ciudad,this.formulario.value.estado].filter(Boolean).join(", "),r=new FormData;r.append("tipo",this.formulario.value.tipoServicio),r.append("titulo",this.formulario.value.titulo),r.append("descripcion",this.formulario.value.descripcion),r.append("ubicacion[direccion]",e),r.append("ubicacion[referencia]",this.formulario.value.referencia||""),r.append("ubicacion[latitud]",this.coordenadas.lat.toString()),r.append("ubicacion[longitud]",this.coordenadas.lng.toString()),r.append("urgencia",this.formulario.value.urgencia==="emergencia"?"emergencia":"normal"),this.formulario.value.fechaPreferida&&r.append("fechaPreferida",this.formulario.value.fechaPreferida),this.formulario.value.horarioPreferido&&r.append("horaPreferida",this.formulario.value.horarioPreferido),this.archivosSeleccionados.forEach(o=>{r.append("fotos",o)}),this.serviciosServicio.crearServicio(r).subscribe({next:o=>S(this,null,function*(){this.enviando=!1,(o.datos?.servicio||o.datos)?._id&&(yield this.mostrarExito(),this.router.navigate(["/tabs/inicio"]))}),error:o=>{this.enviando=!1;let c=o.error?.mensaje||"Error al crear el servicio";this.mostrarToast(c,"danger"),console.error("Error:",o)}})})}mostrarExito(){return S(this,null,function*(){yield(yield this.alertCtrl.create({header:"\xA1Solicitud Creada!",message:"Tu solicitud de servicio ha sido publicada. Los t\xE9cnicos cercanos podr\xE1n enviarte cotizaciones.",buttons:["Entendido"]})).present()})}mostrarToast(e,r="primary"){return S(this,null,function*(){yield(yield this.toastCtrl.create({message:e,duration:2e3,color:r,position:"bottom"})).present()})}obtenerEtiquetaTipo(e){return w.find(o=>o.valor===e)?.etiqueta||e}static{this.\u0275fac=function(r){return new(r||n)}}static{this.\u0275cmp=F({type:n,selectors:[["app-nuevo-servicio"]],standalone:!0,features:[k],decls:93,vars:14,consts:[["inputFoto",""],["slot","start"],["defaultHref","/tabs/servicios"],[3,"ngSubmit","formGroup"],["position","stacked"],["formControlName","titulo","placeholder","Ej: Fuga de agua en el ba\xF1o"],["color","danger",1,"error-note"],["formControlName","descripcion","placeholder","Describe el problema con el mayor detalle posible...","rows","4"],[1,"seccion-titulo"],["formControlName","direccion","placeholder","Ej: Sector, calle"],["formControlName","ciudad","placeholder","Ej: Quito"],["formControlName","estado","placeholder","Ej: Pichincha"],["formControlName","referencia","placeholder","Ej: Cerca del parque, frente a la farmacia","type","text"],["fill","outline","expand","block",3,"click","disabled"],["name","crescent"],["color","success",1,"ubicacion-confirmada"],[1,"seccion-descripcion"],[1,"fotos-grid"],[1,"foto-item"],[1,"foto-agregar"],["type","file","accept","image/*","multiple","",2,"display","none",3,"change"],["formControlName","urgencia","interface","action-sheet"],["value","normal"],["value","emergencia"],[1,"alerta-emergencia"],["type","date","formControlName","fechaPreferida",3,"min"],["formControlName","horarioPreferido","interface","action-sheet"],["value","manana"],["value","tarde"],["value","noche"],["value","cualquiera"],[1,"ion-padding"],["expand","block","type","submit",3,"disabled"],["readonly","true",3,"value"],["formControlName","tipoServicio","placeholder","Selecciona el tipo de servicio","interface","action-sheet"],[3,"value"],["name","location-outline","slot","start"],["name","checkmark-circle-outline"],["alt","Foto del problema",3,"src"],["name","close-circle",1,"btn-eliminar",3,"click"],[1,"foto-agregar",3,"click"],["name","add-outline"],["name","flash-outline"]],template:function(r,o){if(r&1){let c=N();t(0,"ion-header")(1,"ion-toolbar")(2,"ion-buttons",1),m(3,"ion-back-button",2),i(),t(4,"ion-title"),a(5,"Nuevo Servicio"),i()()(),t(6,"ion-content")(7,"form",3),E("ngSubmit",function(){return x(c),C(o.enviar())}),t(8,"ion-card")(9,"ion-card-content"),v(10,xe,4,1,"ion-item")(11,Pe,7,1),t(12,"ion-item")(13,"ion-label",4),a(14,"T\xEDtulo del problema *"),i(),m(15,"ion-input",5),i(),v(16,Ne,2,0,"ion-note",6)(17,Te,2,0,"ion-note",6),t(18,"ion-item")(19,"ion-label",4),a(20,"Descripci\xF3n detallada *"),i(),m(21,"ion-textarea",7),i(),v(22,ye,2,0,"ion-note",6)(23,we,2,0,"ion-note",6),i()(),t(24,"ion-card")(25,"ion-card-content")(26,"h3",8),a(27,"Ubicaci\xF3n del servicio (verifica que sea correcta)"),i(),t(28,"ion-item")(29,"ion-label",4),a(30,"Direcci\xF3n *"),i(),m(31,"ion-input",9),i(),t(32,"ion-item")(33,"ion-label",4),a(34,"Ciudad *"),i(),m(35,"ion-input",10),i(),t(36,"ion-item")(37,"ion-label",4),a(38,"Provincia *"),i(),m(39,"ion-input",11),i(),t(40,"ion-item")(41,"ion-label",4),a(42,"Referencia"),i(),m(43,"ion-input",12),i(),t(44,"ion-button",13),E("click",function(){return x(c),C(o.obtenerUbicacion())}),v(45,Fe,1,0,"ion-spinner",14)(46,Oe,2,0),i(),v(47,Ie,3,0,"ion-note",15),i()(),t(48,"ion-card")(49,"ion-card-content")(50,"h3",8),a(51,"Fotos del problema (opcional)"),i(),t(52,"p",16),a(53,"Las fotos ayudan a los t\xE9cnicos a entender mejor el problema"),i(),t(54,"div",17),T(55,Me,3,1,"div",18,I),v(57,ke,4,0,"div",19),i(),t(58,"input",20,0),E("change",function(u){return x(c),C(o.onFotoSeleccionada(u))}),i()()(),t(60,"ion-card")(61,"ion-card-content")(62,"h3",8),a(63,"Urgencia y disponibilidad"),i(),t(64,"ion-item")(65,"ion-label",4),a(66,"Nivel de urgencia *"),i(),t(67,"ion-select",21)(68,"ion-select-option",22),a(69," Normal - Programar para los pr\xF3ximos d\xEDas "),i(),t(70,"ion-select-option",23),a(71," \u{1F6A8} Emergencia - \xA1Lo necesito AHORA! "),i()()(),v(72,qe,4,0,"div",24),t(73,"ion-item")(74,"ion-label",4),a(75,"Fecha preferida (opcional)"),i(),m(76,"ion-input",25),i(),t(77,"ion-item")(78,"ion-label",4),a(79,"Horario preferido (opcional)"),i(),t(80,"ion-select",26)(81,"ion-select-option",27),a(82,"Ma\xF1ana (8am - 12pm)"),i(),t(83,"ion-select-option",28),a(84,"Tarde (12pm - 6pm)"),i(),t(85,"ion-select-option",29),a(86,"Noche (6pm - 9pm)"),i(),t(87,"ion-select-option",30),a(88,"Cualquier horario"),i()()()()(),t(89,"div",31)(90,"ion-button",32),v(91,De,1,0,"ion-spinner",14)(92,Ve,1,0),i()()()()}if(r&2){let c,l,u,f,h;s(7),b("formGroup",o.formulario),s(3),p(o.tipoPreseleccionado?10:11),s(6),p((c=o.formulario.get("titulo"))!=null&&c.touched&&(!((c=o.formulario.get("titulo"))==null||c.errors==null)&&c.errors.required)?16:-1),s(),p(!((l=o.formulario.get("titulo"))==null||l.errors==null)&&l.errors.minlength?17:-1),s(5),p((u=o.formulario.get("descripcion"))!=null&&u.touched&&(!((u=o.formulario.get("descripcion"))==null||u.errors==null)&&u.errors.required)?22:-1),s(),p(!((f=o.formulario.get("descripcion"))==null||f.errors==null)&&f.errors.minlength?23:-1),s(21),b("disabled",o.obteniendoUbicacion),s(),p(o.obteniendoUbicacion?45:46),s(2),p(o.coordenadas?47:-1),s(8),y(o.fotosPreview),s(2),p(o.fotosPreview.length<5?57:-1),s(15),p(((h=o.formulario.get("urgencia"))==null?null:h.value)==="emergencia"?72:-1),s(4),b("min",o.fechaMinima),s(14),b("disabled",!o.formulario.valid||o.enviando),s(),p(o.enviando?91:92)}},dependencies:[K,W,oe,te,H,B,Q,J,X,Y,le,se,ce,ee,G,ae,ie,Z,R,j,z,U,L,A],styles:["ion-card[_ngcontent-%COMP%]{margin:16px;border-radius:12px}.seccion-titulo[_ngcontent-%COMP%]{font-size:16px;font-weight:600;margin:0 0 8px;color:var(--ion-text-color)}.seccion-descripcion[_ngcontent-%COMP%]{font-size:13px;color:var(--ion-color-medium);margin:0 0 16px}.error-note[_ngcontent-%COMP%]{display:block;padding:4px 16px;font-size:12px}.ubicacion-confirmada[_ngcontent-%COMP%]{display:flex;align-items:center;gap:4px;padding:8px 16px;font-size:13px}.fotos-grid[_ngcontent-%COMP%]{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:12px}.foto-item[_ngcontent-%COMP%]{position:relative;aspect-ratio:1;border-radius:8px;overflow:hidden}.foto-item[_ngcontent-%COMP%]   img[_ngcontent-%COMP%]{width:100%;height:100%;object-fit:cover}.foto-item[_ngcontent-%COMP%]   .btn-eliminar[_ngcontent-%COMP%]{position:absolute;top:4px;right:4px;font-size:24px;color:var(--ion-color-danger);background:#fff;border-radius:50%;cursor:pointer}.foto-agregar[_ngcontent-%COMP%]{aspect-ratio:1;border:2px dashed var(--ion-color-medium);border-radius:8px;display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;color:var(--ion-color-medium)}.foto-agregar[_ngcontent-%COMP%]   ion-icon[_ngcontent-%COMP%]{font-size:32px}.foto-agregar[_ngcontent-%COMP%]   span[_ngcontent-%COMP%]{font-size:12px;margin-top:4px}.foto-agregar[_ngcontent-%COMP%]:active{background:var(--ion-color-light)}.alerta-emergencia[_ngcontent-%COMP%]{display:flex;align-items:center;gap:8px;padding:12px;background:var(--ion-color-danger-tint);border-radius:8px;margin:12px 0;color:#fff;font-size:13px}.alerta-emergencia[_ngcontent-%COMP%]   ion-icon[_ngcontent-%COMP%]{font-size:20px}ion-button[type=submit][_ngcontent-%COMP%]{height:48px;font-size:16px}"]})}}return n})();export{Ye as NuevoServicioPage};
