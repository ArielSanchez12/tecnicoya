import{a as pe}from"./chunk-X344YWBZ.js";import{a as le}from"./chunk-VZSTYWCH.js";import{a as ae,q as re,r as se,sa as ce,ua as de}from"./chunk-TI2PQS3J.js";import{a as oe}from"./chunk-XRERQNEZ.js";import{a as P}from"./chunk-JQ3F7U5Y.js";import{A as y,Aa as L,B as r,C as o,D as l,E as T,Ea as q,F as x,G as b,Ga as G,H as E,Ha as J,I as w,J as B,K as g,L as v,O as V,Oa as K,P as U,Q as A,R as D,Ra as X,Sa as Y,T as F,V as z,Z as R,ca as $,eb as Z,ga as N,ib as ee,j as h,jb as te,k as O,l as _,m as f,n as I,o as a,oa as H,qa as W,r as p,s as M,sb as ne,tb as ie,u as S,w as u,wa as Q,z as k}from"./chunk-IBAPA63D.js";import"./chunk-XMAMLXFW.js";import"./chunk-EW67HA6M.js";import"./chunk-WXVXXLBH.js";import"./chunk-EFAAWUSX.js";import"./chunk-GLOUZK3F.js";import"./chunk-N4PXAYQ7.js";import"./chunk-4WFVMWDK.js";import"./chunk-M2X7KQLB.js";import"./chunk-2YSZFPCQ.js";import"./chunk-57YRIO75.js";import"./chunk-NMPY7VJP.js";import"./chunk-C5RQ2IC2.js";import"./chunk-42C7ZIID.js";import"./chunk-B4AJQJMI.js";var ue=["content"],me=(t,c)=>c._id;function he(t,c){t&1&&(r(0,"span",14),l(1,"ion-icon",16),g(2," T\xE9cnico verificado "),o())}function ge(t,c){t&1&&(r(0,"span",15),g(1,"En l\xEDnea"),o())}function _e(t,c){if(t&1&&(r(0,"ion-avatar",9),l(1,"img",10),o(),r(2,"ion-title")(3,"div",11)(4,"div",12)(5,"span",13),g(6),o(),p(7,he,3,0,"span",14),o(),p(8,ge,2,0,"span",15),o()()),t&2){let e=b();a(),M("src",(e.receptor.perfil==null?null:e.receptor.perfil.fotoUrl)||(e.receptor.perfil==null?null:e.receptor.perfil.fotoPerfil)||"assets/avatar-default.png",I),a(5),v(e.obtenerNombreReceptor()),a(),u(e.esUsuarioVerificado(e.receptor)?7:-1),a(),u(e.receptorEnLinea?8:-1)}}function fe(t,c){t&1&&(r(0,"div",3),l(1,"ion-spinner"),o())}function be(t,c){t&1&&l(0,"ion-icon",23)}function Ce(t,c){t&1&&l(0,"ion-icon",24)}function ve(t,c){if(t&1&&(r(0,"span",22),p(1,be,1,0,"ion-icon",23)(2,Ce,1,0,"ion-icon",24),o()),t&2){let e=b().$implicit;a(),u(e.leido?1:2)}}function Me(t,c){if(t&1&&(r(0,"div",19)(1,"div",20)(2,"p"),g(3),o(),r(4,"span",21),g(5),F(6,"date"),o(),p(7,ve,3,1,"span",22),o()()),t&2){let e=c.$implicit,i=b(2);S("enviado",i.esMio(e))("recibido",!i.esMio(e)),a(3),v(e.contenido),a(2),v(z(6,7,e.createdAt,"HH:mm")),a(2),u(i.esMio(e)?7:-1)}}function xe(t,c){t&1&&(r(0,"div",18)(1,"div",25)(2,"div",26),l(3,"span")(4,"span")(5,"span"),o()()())}function Pe(t,c){if(t&1&&(r(0,"div",4),k(1,Me,8,10,"div",17,me),p(3,xe,6,0,"div",18),o()),t&2){let e=b();a(),y(e.mensajes),a(2),u(e.escribiendo?3:-1)}}var He=(()=>{class t{constructor(){this.route=h(N),this.http=h($),this.socketServicio=h(le),this.authServicio=h(oe),this.usuariosServicio=h(pe),this.receptorId="",this.trabajoId="",this.receptor=null,this.receptorEnLinea=!1,this.mensajes=[],this.nuevoMensaje="",this.cargando=!1,this.escribiendo=!1,this.subscriptions=[],ae({sendOutline:ce,shieldCheckmarkOutline:de,checkmarkDoneOutline:re,checkmarkOutline:se})}ngOnInit(){this.receptorId=this.route.snapshot.paramMap.get("id")||"",this.trabajoId=this.route.snapshot.queryParamMap.get("trabajoId")||"",this.receptorId&&(this.cargarReceptor(),this.cargarMensajes(),this.configurarSocket(),this.trabajoId?this.socketServicio.unirseChat(this.trabajoId):this.socketServicio.unirseChatDirecto(this.receptorId))}ngOnDestroy(){this.subscriptions.forEach(e=>e.unsubscribe()),this.escribiendoTimeout&&clearTimeout(this.escribiendoTimeout),this.trabajoId&&this.socketServicio.salirChat(this.trabajoId)}cargarReceptor(){this.usuariosServicio.obtenerPerfil(this.receptorId).subscribe({next:e=>{e.datos&&(this.receptor=e.datos)}})}cargarMensajes(){this.cargando=!0;let e=this.trabajoId?`${P.apiUrl}/mensajes/trabajo/${this.trabajoId}`:`${P.apiUrl}/mensajes/conversacion/${this.receptorId}`;this.http.get(e).subscribe({next:i=>{this.cargando=!1,i.datos&&(this.mensajes=i.datos.map(n=>({_id:n._id,emisor:n.idEmisor?._id||n.idEmisor,receptor:n.idReceptor,contenido:n.contenido,tipo:n.tipoMensaje||"texto",leido:n.leido,createdAt:n.fechaEnvio||n.fechaCreacion})),this.scrollToBottom())},error:()=>{this.cargando=!1,this.mensajes=[]}})}configurarSocket(){let i=this.authServicio.obtenerUsuarioActual()?._id,n=this.socketServicio.escucharMensajes().subscribe(s=>{if(this.mensajes.some(m=>m._id===s._id||m._id?.toString().startsWith("temp_")&&m.contenido===s.contenido&&m.emisor===s.emisor)){if(s.emisor===i){let m=this.mensajes.findIndex(j=>j._id?.toString().startsWith("temp_")&&j.contenido===s.contenido);m!==-1&&(this.mensajes[m]=s)}return}s.emisor===this.receptorId&&(this.mensajes.push(s),this.scrollToBottom(),this.escribiendo=!1)});this.subscriptions.push(n);let d=this.socketServicio.escucharEscribiendo().subscribe(s=>{s.usuarioId===this.receptorId&&(this.escribiendo=!0,this.scrollToBottom(),this.escribiendoTimeout&&clearTimeout(this.escribiendoTimeout),this.escribiendoTimeout=setTimeout(()=>{this.escribiendo=!1},3e3))});this.subscriptions.push(d)}esMio(e){let i=this.authServicio.obtenerUsuarioActual();return e.emisor===i?._id}onEscribiendo(){this.socketServicio.emitirEscribiendo(this.receptorId)}enviarMensaje(){if(!this.nuevoMensaje.trim())return;let e=this.authServicio.obtenerUsuarioActual();if(!e)return;let i=this.nuevoMensaje.trim(),n={_id:"temp_"+Date.now(),emisor:e._id,receptor:this.receptorId,contenido:i,tipo:"texto",createdAt:new Date().toISOString()};this.mensajes.push(n),this.nuevoMensaje="",this.scrollToBottom(),this.trabajoId?this.socketServicio.enviarMensajeTrabajo(this.trabajoId,i):this.socketServicio.enviarMensaje(this.receptorId,i)}scrollToBottom(){setTimeout(()=>{this.content?.scrollToBottom(300)},100)}esUsuarioVerificado(e){return e?.datosTecnico?.membresia?.badgeVerificado===!0||e?.datosTecnico?.verificado===!0}obtenerNombreReceptor(){if(!this.receptor)return"";let e=this.receptor.perfil?.nombre||this.receptor.nombre||"",i=this.receptor.perfil?.apellido||this.receptor.apellido||"";return`${e} ${i}`.trim()||"Usuario"}static{this.\u0275fac=function(i){return new(i||t)}}static{this.\u0275cmp=O({type:t,selectors:[["app-chat"]],viewQuery:function(i,n){if(i&1&&E(ue,5),i&2){let d;w(d=B())&&(n.content=d.first)}},standalone:!0,features:[D],decls:14,vars:4,consts:[["content",""],["slot","start"],["defaultHref","/tabs/inicio"],[1,"loading-container"],[1,"mensajes-container"],[1,"input-container"],["placeholder","Escribe un mensaje...",3,"ngModelChange","keyup.enter","ionInput","ngModel"],["fill","clear",3,"click","disabled"],["name","send-outline","color","primary"],["slot","start",1,"avatar-header"],["alt","",3,"src"],[1,"titulo-chat"],[1,"nombre-row"],[1,"nombre"],[1,"badge-tecnico-verificado"],[1,"estado-linea"],["name","shield-checkmark-outline"],[1,"mensaje",3,"enviado","recibido"],[1,"mensaje","recibido"],[1,"mensaje"],[1,"burbuja"],[1,"hora"],[1,"estado-mensaje"],["name","checkmark-done-outline","color","primary"],["name","checkmark-outline"],[1,"burbuja","escribiendo"],[1,"puntos"]],template:function(i,n){if(i&1){let d=T();r(0,"ion-header")(1,"ion-toolbar")(2,"ion-buttons",1),l(3,"ion-back-button",2),o(),p(4,_e,9,4),o()(),r(5,"ion-content",null,0),p(7,fe,2,0,"div",3)(8,Pe,4,1,"div",4),o(),r(9,"ion-footer")(10,"div",5)(11,"ion-input",6),A("ngModelChange",function(C){return _(d),U(n.nuevoMensaje,C)||(n.nuevoMensaje=C),f(C)}),x("keyup.enter",function(){return _(d),f(n.enviarMensaje())})("ionInput",function(){return _(d),f(n.onEscribiendo())}),o(),r(12,"ion-button",7),x("click",function(){return _(d),f(n.enviarMensaje())}),l(13,"ion-icon",8),o()()()}i&2&&(a(4),u(n.receptor?4:-1),a(3),u(n.cargando?7:8),a(4),V("ngModel",n.nuevoMensaje),a(),M("disabled",!n.nuevoMensaje.trim()))},dependencies:[K,Y,te,ee,J,L,X,ie,G,ne,q,Z,R,Q,H,W],styles:[".avatar-header[_ngcontent-%COMP%]{width:36px;height:36px;margin-right:8px}.titulo-chat[_ngcontent-%COMP%]{display:flex;flex-direction:column}.titulo-chat[_ngcontent-%COMP%]   .nombre-row[_ngcontent-%COMP%]{display:flex;align-items:center;gap:8px;flex-wrap:wrap}.titulo-chat[_ngcontent-%COMP%]   .nombre[_ngcontent-%COMP%]{font-size:16px;font-weight:600}.titulo-chat[_ngcontent-%COMP%]   .badge-tecnico-verificado[_ngcontent-%COMP%]{display:inline-flex;align-items:center;gap:4px;background:linear-gradient(135deg,#2e7d32,#4caf50);color:#fff;font-size:10px;font-weight:600;padding:3px 8px;border-radius:4px}.titulo-chat[_ngcontent-%COMP%]   .badge-tecnico-verificado[_ngcontent-%COMP%]   ion-icon[_ngcontent-%COMP%]{font-size:12px}.titulo-chat[_ngcontent-%COMP%]   .estado-linea[_ngcontent-%COMP%]{font-size:11px;color:var(--ion-color-success);font-weight:400}.loading-container[_ngcontent-%COMP%]{display:flex;justify-content:center;padding:32px}.mensajes-container[_ngcontent-%COMP%]{display:flex;flex-direction:column;padding:16px;min-height:100%}.mensaje[_ngcontent-%COMP%]{display:flex;margin-bottom:8px;max-width:80%}.mensaje.enviado[_ngcontent-%COMP%]{align-self:flex-end}.mensaje.enviado[_ngcontent-%COMP%]   .burbuja[_ngcontent-%COMP%]{background:var(--ion-color-primary);color:#fff;border-radius:18px 18px 4px}.mensaje.enviado[_ngcontent-%COMP%]   .burbuja[_ngcontent-%COMP%]   .hora[_ngcontent-%COMP%]{color:#ffffffb3}.mensaje.recibido[_ngcontent-%COMP%]{align-self:flex-start}.mensaje.recibido[_ngcontent-%COMP%]   .burbuja[_ngcontent-%COMP%]{background:var(--ion-color-light);color:var(--ion-text-color);border-radius:18px 18px 18px 4px}.mensaje.recibido[_ngcontent-%COMP%]   .burbuja[_ngcontent-%COMP%]   .hora[_ngcontent-%COMP%]{color:var(--ion-color-medium)}.burbuja[_ngcontent-%COMP%]{padding:10px 14px;position:relative}.burbuja[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{margin:0;font-size:15px;line-height:1.4}.burbuja[_ngcontent-%COMP%]   .hora[_ngcontent-%COMP%]{font-size:10px;margin-left:8px;float:right;margin-top:4px}.burbuja[_ngcontent-%COMP%]   .estado-mensaje[_ngcontent-%COMP%]{margin-left:2px}.burbuja[_ngcontent-%COMP%]   .estado-mensaje[_ngcontent-%COMP%]   ion-icon[_ngcontent-%COMP%]{font-size:14px;vertical-align:middle}.escribiendo[_ngcontent-%COMP%]   .puntos[_ngcontent-%COMP%]{display:flex;gap:4px;padding:4px 8px}.escribiendo[_ngcontent-%COMP%]   .puntos[_ngcontent-%COMP%]   span[_ngcontent-%COMP%]{width:8px;height:8px;background:var(--ion-color-medium);border-radius:50%;animation:_ngcontent-%COMP%_bounce 1.4s infinite ease-in-out}.escribiendo[_ngcontent-%COMP%]   .puntos[_ngcontent-%COMP%]   span[_ngcontent-%COMP%]:nth-child(1){animation-delay:-.32s}.escribiendo[_ngcontent-%COMP%]   .puntos[_ngcontent-%COMP%]   span[_ngcontent-%COMP%]:nth-child(2){animation-delay:-.16s}.escribiendo[_ngcontent-%COMP%]   .puntos[_ngcontent-%COMP%]   span[_ngcontent-%COMP%]:nth-child(3){animation-delay:0s}@keyframes _ngcontent-%COMP%_bounce{0%,80%,to{transform:scale(0)}40%{transform:scale(1)}}ion-footer[_ngcontent-%COMP%]{background:var(--ion-background-color);border-top:1px solid var(--ion-color-light)}.input-container[_ngcontent-%COMP%]{display:flex;align-items:center;padding:8px 12px;gap:8px}.input-container[_ngcontent-%COMP%]   ion-input[_ngcontent-%COMP%]{--background: #f5f5f5;--color: #333;--placeholder-color: #888;--border-radius: 20px;--padding-start: 16px;--padding-end: 16px;flex:1;color:#333!important}"]})}}return t})();export{He as ChatPage};
