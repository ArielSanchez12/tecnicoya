import{a as Ei}from"./chunk-RL3NGRP4.js";import{a as Pi}from"./chunk-2WRDL5NI.js";import{D as xi,Da as zi,Ea as Mi,_ as vi,a as gi,b as _i,d as Ci,m as hi,o as fi,ua as bi}from"./chunk-TI2PQS3J.js";import"./chunk-JQ3F7U5Y.js";import{$ as D,A as V,Aa as J,B as n,C as o,D as s,E as O,F as f,G as u,Ga as K,Ha as X,Ia as Y,Ja as Z,K as a,Ka as ii,L as x,M as b,Ma as ei,O as z,Oa as ti,P as M,Q as P,R as U,S as E,Sa as ni,T as y,Ua as oi,X as I,Ya as ai,_a as ri,eb as ci,ga as j,ia as B,ib as li,j as g,jb as si,k as N,l as m,m as p,na as T,o as l,oa as W,pa as q,qa as A,qb as di,r as _,ra as $,s as C,sa as L,sb as mi,ta as G,tb as pi,va as H,w as h,wa as R,x as k,xa as Q,xb as ui,z as F}from"./chunk-IBAPA63D.js";import"./chunk-XMAMLXFW.js";import"./chunk-EW67HA6M.js";import"./chunk-WXVXXLBH.js";import"./chunk-EFAAWUSX.js";import"./chunk-GLOUZK3F.js";import"./chunk-N4PXAYQ7.js";import"./chunk-4WFVMWDK.js";import"./chunk-M2X7KQLB.js";import"./chunk-2YSZFPCQ.js";import"./chunk-57YRIO75.js";import"./chunk-NMPY7VJP.js";import"./chunk-C5RQ2IC2.js";import"./chunk-42C7ZIID.js";import{h as v}from"./chunk-B4AJQJMI.js";var w=()=>({standalone:!0});function Si(r,d){r&1&&(n(0,"div",2),s(1,"ion-spinner"),o())}function Oi(r,d){r&1&&(n(0,"ion-card",3)(1,"ion-card-content"),s(2,"ion-icon",24),n(3,"div")(4,"strong"),a(5,"Editando cotizaci\xF3n"),o(),n(6,"p"),a(7,"Si guardas los cambios, el cliente ser\xE1 notificado para que revise la nueva cotizaci\xF3n."),o()()()())}function yi(r,d){r&1&&(n(0,"ion-note",10),a(1,"La descripci\xF3n es obligatoria"),o())}function Ii(r,d){if(r&1){let i=O();n(0,"div",12)(1,"div",25)(2,"span",26),a(3),o(),n(4,"ion-button",27),f("click",function(){let e=m(i).$index,c=u(2);return p(c.eliminarItem(e))}),s(5,"ion-icon",28),o()(),n(6,"ion-item")(7,"ion-label",17),a(8,"Concepto"),o(),n(9,"ion-input",29),P("ngModelChange",function(e){let c=m(i).$implicit;return M(c.concepto,e)||(c.concepto=e),p(e)}),o()(),n(10,"div",30)(11,"ion-item")(12,"ion-label",17),a(13,"Cantidad"),o(),n(14,"ion-input",31),P("ngModelChange",function(e){let c=m(i).$implicit;return M(c.cantidad,e)||(c.cantidad=e),p(e)}),f("ionInput",function(){let e=m(i).$index,c=u(2);return p(c.calcularTotalItem(e))}),o()(),n(15,"ion-item")(16,"ion-label",17),a(17,"Precio Unit."),o(),n(18,"ion-input",32),P("ngModelChange",function(e){let c=m(i).$implicit;return M(c.precioUnitario,e)||(c.precioUnitario=e),p(e)}),f("ionInput",function(){let e=m(i).$index,c=u(2);return p(c.calcularTotalItem(e))}),o()()(),n(19,"div",33)(20,"span"),a(21,"Subtotal:"),o(),n(22,"strong"),a(23),y(24,"currency"),o()()()}if(r&2){let i=d.$implicit,t=d.$index;l(3),b("#",t+1,""),l(6),z("ngModel",i.concepto),C("ngModelOptions",E(13,w)),l(5),z("ngModel",i.cantidad),C("ngModelOptions",E(14,w)),l(4),z("ngModel",i.precioUnitario),C("ngModelOptions",E(15,w)),l(5),x(I(24,8,i.total,"USD","symbol","1.2-2"))}}function Ti(r,d){r&1&&(n(0,"ion-note",10),a(1,"El tiempo estimado es obligatorio"),o())}function wi(r,d){r&1&&s(0,"ion-spinner",23)}function Ni(r,d){if(r&1&&(s(0,"ion-icon",34),a(1)),r&2){let i=u(2);l(),b(" ",i.modoEdicion?"Guardar Cambios":"Enviar Cotizaci\xF3n"," ")}}function ki(r,d){if(r&1){let i=O();_(0,Oi,8,0,"ion-card",3),n(1,"ion-card")(2,"ion-card-header")(3,"ion-card-title"),a(4,"Servicio Solicitado"),o()(),n(5,"ion-card-content")(6,"h3"),a(7),o(),n(8,"p",4),a(9),o(),n(10,"p",5),s(11,"ion-icon",6),a(12),o()()(),n(13,"form",7),f("ngSubmit",function(){m(i);let e=u();return p(e.enviar())}),n(14,"ion-card")(15,"ion-card-header")(16,"ion-card-title"),s(17,"ion-icon",8),a(18," Descripci\xF3n del trabajo "),o()(),n(19,"ion-card-content")(20,"ion-item"),s(21,"ion-textarea",9),o(),_(22,yi,2,0,"ion-note",10),o()(),n(23,"ion-card")(24,"ion-card-header")(25,"ion-card-title"),s(26,"ion-icon",11),a(27," Desglose de costos "),o()(),n(28,"ion-card-content"),F(29,Ii,25,16,"div",12,k),n(31,"ion-button",13),f("click",function(){m(i);let e=u();return p(e.agregarItem())}),s(32,"ion-icon",14),a(33," Agregar Concepto "),o(),n(34,"div",15)(35,"span"),a(36,"TOTAL:"),o(),n(37,"strong"),a(38),y(39,"currency"),o()()()(),n(40,"ion-card")(41,"ion-card-header")(42,"ion-card-title"),s(43,"ion-icon",16),a(44," Tiempo estimado "),o()(),n(45,"ion-card-content")(46,"ion-item")(47,"ion-label",17),a(48,"Duraci\xF3n del trabajo"),o(),s(49,"ion-input",18),o(),_(50,Ti,2,0,"ion-note",10),o()(),n(51,"ion-card")(52,"ion-card-header")(53,"ion-card-title"),s(54,"ion-icon",19),a(55," Garant\xEDa (opcional) "),o()(),n(56,"ion-card-content")(57,"ion-item"),s(58,"ion-textarea",20),o()()(),n(59,"div",21)(60,"ion-button",22),_(61,wi,1,0,"ion-spinner",23)(62,Ni,2,1),o()()()}if(r&2){let i,t,e=u();h(e.modoEdicion?0:-1),l(7),x(e.servicio.titulo),l(2),x(e.servicio.descripcion),l(3),b(" ",e.obtenerUbicacionTexto()," "),l(),C("formGroup",e.formulario),l(9),h((i=e.formulario.get("descripcion"))!=null&&i.touched&&(!((i=e.formulario.get("descripcion"))==null||i.errors==null)&&i.errors.required)?22:-1),l(7),V(e.items),l(9),x(I(39,11,e.calcularTotal(),"USD","symbol","1.2-2")),l(12),h((t=e.formulario.get("tiempoEstimado"))!=null&&t.touched&&(!((t=e.formulario.get("tiempoEstimado"))==null||t.errors==null)&&t.errors.required)?50:-1),l(10),C("color",e.modoEdicion?"success":"primary")("disabled",!e.formulario.valid||e.items.length===0||e.enviando),l(),h(e.enviando?61:62)}}var Ji=(()=>{class r{constructor(){this.route=g(j),this.router=g(B),this.fb=g(H),this.cotizacionesServicio=g(Ei),this.serviciosServicio=g(Pi),this.toastCtrl=g(di),this.servicio=null,this.items=[],this.cargando=!1,this.enviando=!1,this.modoEdicion=!1,this.cotizacionId=null,gi({cashOutline:hi,timeOutline:zi,documentTextOutline:xi,addCircleOutline:_i,trashOutline:Mi,checkmarkCircle:fi,shieldCheckmarkOutline:bi,locationOutline:vi,alertCircleOutline:Ci})}ngOnInit(){this.formulario=this.fb.group({descripcion:["",T.required],tiempoEstimado:["",T.required],garantia:[""]});let i=this.route.snapshot.paramMap.get("id"),t=this.route.snapshot.url[0]?.path||"",e=this.route.snapshot.queryParamMap.get("editar");t==="editar-cotizacion"?(this.modoEdicion=!0,this.cotizacionId=i,this.cargarCotizacionPorId(i)):e?(this.modoEdicion=!0,this.cotizacionId=e,this.cargarCotizacionPorId(e)):(this.cargarServicio(i),this.agregarItem())}cargarCotizacionPorId(i){this.cargando=!0,this.cotizacionesServicio.obtenerMisCotizaciones({limite:100}).subscribe({next:t=>{let c=(t.datos?.cotizaciones||t.datos||[]).find(S=>S._id===i);if(c){let S=c.idServicio?._id||c.idServicio;this.cargarServicio(S),this.cargarCotizacionDatos(c)}else this.cargando=!1},error:()=>{this.cargando=!1}})}cargarCotizacionDatos(i){this.formulario.patchValue({descripcion:i.descripcionTrabajo||i.descripcion||"",tiempoEstimado:i.tiempoEstimado?`${i.tiempoEstimado.valor} ${i.tiempoEstimado.unidad}`:"",garantia:i.notasAdicionales||""}),i.materiales&&i.materiales.length>0?this.items=i.materiales.map(t=>({concepto:t.nombre||t.concepto,cantidad:t.cantidad||1,precioUnitario:t.precioUnitario||0,total:(t.cantidad||1)*(t.precioUnitario||0)})):i.desglose&&i.desglose.length>0?this.items=i.desglose.map(t=>({concepto:t.concepto,cantidad:t.cantidad,precioUnitario:t.precioUnitario,total:t.cantidad*t.precioUnitario})):this.items=[{concepto:"Servicio",cantidad:1,precioUnitario:i.precio||i.montoTotal||0,total:i.precio||i.montoTotal||0}]}cargarServicio(i){this.cargando=!0,this.serviciosServicio.obtenerServicio(i).subscribe({next:t=>{if(this.cargando=!1,t.datos){let e=t.datos;this.servicio=e.servicio||e}},error:()=>{this.cargando=!1}})}obtenerUbicacionTexto(){if(!this.servicio?.ubicacion)return"Sin ubicaci\xF3n";let i=this.servicio.ubicacion;return typeof i=="string"?i:i.direccion||i.ciudad||"Sin ubicaci\xF3n"}agregarItem(){this.items.push({concepto:"",cantidad:1,precioUnitario:0,total:0})}eliminarItem(i){this.items.length>1&&this.items.splice(i,1)}calcularTotalItem(i){let t=this.items[i];t.total=t.cantidad*t.precioUnitario}calcularTotal(){return this.items.reduce((i,t)=>i+t.total,0)}enviar(){if(!this.formulario.valid||!this.servicio||this.items.length===0){this.formulario.markAllAsTouched();return}let i=this.items.filter(e=>e.concepto&&e.cantidad>0&&e.precioUnitario>0);if(i.length===0){this.mostrarToast("Agrega al menos un concepto con precio","warning");return}this.enviando=!0;let t={servicio:this.servicio._id,descripcion:this.formulario.value.descripcion,tiempoEstimado:this.formulario.value.tiempoEstimado,garantia:this.formulario.value.garantia||void 0,desglose:i.map(e=>({concepto:e.concepto,cantidad:e.cantidad,precioUnitario:e.precioUnitario,subtotal:e.total})),montoTotal:this.calcularTotal()};this.modoEdicion&&this.cotizacionId?this.cotizacionesServicio.editarCotizacion(this.cotizacionId,t).subscribe({next:()=>v(this,null,function*(){this.enviando=!1,yield this.mostrarToast("\xA1Cotizaci\xF3n actualizada! El cliente ha sido notificado.","success"),this.router.navigate(["/tabs/inicio"])}),error:e=>{this.enviando=!1;let c=e.error?.mensaje||"Error al actualizar cotizaci\xF3n";this.mostrarToast(c,"danger")}}):this.cotizacionesServicio.crearCotizacion(t).subscribe({next:()=>v(this,null,function*(){this.enviando=!1,yield this.mostrarToast("\xA1Cotizaci\xF3n enviada exitosamente!","success"),this.router.navigate(["/tabs/buscar"])}),error:()=>{this.enviando=!1,this.mostrarToast("Error al enviar cotizaci\xF3n","danger")}})}mostrarToast(i,t="primary"){return v(this,null,function*(){yield(yield this.toastCtrl.create({message:i,duration:2e3,color:t,position:"bottom"})).present()})}static{this.\u0275fac=function(t){return new(t||r)}}static{this.\u0275cmp=N({type:r,selectors:[["app-nueva-cotizacion"]],standalone:!0,features:[U],decls:9,vars:2,consts:[["slot","start"],["defaultHref","/tabs/buscar"],[1,"loading-container"],[1,"aviso-edicion"],[1,"descripcion"],[1,"ubicacion"],["name","location-outline"],[3,"ngSubmit","formGroup"],["name","document-text-outline"],["formControlName","descripcion","placeholder","Describe qu\xE9 trabajo realizar\xE1s y c\xF3mo lo har\xE1s...","rows","4"],["color","danger",1,"error-note"],["name","cash-outline"],[1,"item-cotizacion"],["fill","outline","expand","block",3,"click"],["name","add-circle-outline","slot","start"],[1,"total-cotizacion"],["name","time-outline"],["position","stacked"],["formControlName","tiempoEstimado","placeholder","Ej: 2 horas, 1 d\xEDa, etc."],["name","shield-checkmark-outline"],["formControlName","garantia","placeholder","Describe la garant\xEDa que ofreces por tu trabajo...","rows","2"],[1,"ion-padding"],["expand","block","type","submit",3,"color","disabled"],["name","crescent"],["name","alert-circle-outline","color","warning"],[1,"item-header"],[1,"item-numero"],["fill","clear","size","small","color","danger",3,"click"],["name","trash-outline"],["placeholder","Ej: Mano de obra, Material, etc.",3,"ngModelChange","ngModel","ngModelOptions"],[1,"item-numeros"],["type","number","min","1",3,"ngModelChange","ionInput","ngModel","ngModelOptions"],["type","number","min","0",3,"ngModelChange","ionInput","ngModel","ngModelOptions"],[1,"item-total"],["name","checkmark-circle","slot","start"]],template:function(t,e){t&1&&(n(0,"ion-header")(1,"ion-toolbar")(2,"ion-buttons",0),s(3,"ion-back-button",1),o(),n(4,"ion-title"),a(5),o()()(),n(6,"ion-content"),_(7,Si,2,0,"div",2)(8,ki,63,16),o()),t&2&&(l(5),x(e.modoEdicion?"Editar Cotizaci\xF3n":"Nueva Cotizaci\xF3n"),l(2),h(e.cargando?7:e.servicio?8:-1))},dependencies:[ti,ni,si,li,X,J,Y,Z,ii,ei,oi,ai,pi,ui,K,mi,ci,ri,D,Q,$,W,q,L,G,R,A],styles:[".loading-container[_ngcontent-%COMP%]{display:flex;justify-content:center;padding:64px}.aviso-edicion[_ngcontent-%COMP%]{margin:16px;border-radius:12px;background:var(--ion-color-warning-tint)}.aviso-edicion[_ngcontent-%COMP%]   ion-card-content[_ngcontent-%COMP%]{display:flex;align-items:flex-start;gap:12px}.aviso-edicion[_ngcontent-%COMP%]   ion-card-content[_ngcontent-%COMP%]   ion-icon[_ngcontent-%COMP%]{font-size:28px;flex-shrink:0;margin-top:2px}.aviso-edicion[_ngcontent-%COMP%]   ion-card-content[_ngcontent-%COMP%]   strong[_ngcontent-%COMP%]{display:block;margin-bottom:4px;color:var(--ion-color-warning-shade)}.aviso-edicion[_ngcontent-%COMP%]   ion-card-content[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{margin:0;font-size:14px;color:var(--ion-color-dark)}ion-card[_ngcontent-%COMP%]{margin:16px;border-radius:12px}ion-card[_ngcontent-%COMP%]   ion-card-title[_ngcontent-%COMP%]{display:flex;align-items:center;gap:8px;font-size:18px}ion-card[_ngcontent-%COMP%]   ion-card-title[_ngcontent-%COMP%]   ion-icon[_ngcontent-%COMP%]{font-size:22px}.descripcion[_ngcontent-%COMP%]{color:var(--ion-color-medium);margin:8px 0}.ubicacion[_ngcontent-%COMP%]{display:flex;align-items:center;gap:4px;color:var(--ion-color-medium);font-size:14px}.ubicacion[_ngcontent-%COMP%]   ion-icon[_ngcontent-%COMP%]{font-size:16px}.error-note[_ngcontent-%COMP%]{display:block;padding:4px 16px;font-size:12px}.item-cotizacion[_ngcontent-%COMP%]{padding:16px;background:var(--ion-background-color-step-100, rgba(var(--ion-text-color-rgb, 0, 0, 0), .05));border-radius:12px;margin-bottom:12px;border:1px solid var(--ion-border-color, rgba(var(--ion-text-color-rgb, 0, 0, 0), .1))}.item-cotizacion[_ngcontent-%COMP%]   .item-header[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}.item-cotizacion[_ngcontent-%COMP%]   .item-header[_ngcontent-%COMP%]   .item-numero[_ngcontent-%COMP%]{font-weight:600;color:var(--ion-color-primary)}.item-cotizacion[_ngcontent-%COMP%]   .item-numeros[_ngcontent-%COMP%]{display:grid;grid-template-columns:1fr 1fr;gap:8px}.item-cotizacion[_ngcontent-%COMP%]   .item-total[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;margin-top:12px;padding-top:12px;border-top:1px solid var(--ion-color-medium-tint)}.item-cotizacion[_ngcontent-%COMP%]   .item-total[_ngcontent-%COMP%]   strong[_ngcontent-%COMP%]{color:var(--ion-color-primary)}.total-cotizacion[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;margin-top:20px;padding:16px;background:var(--ion-color-primary);border-radius:12px;color:#fff}.total-cotizacion[_ngcontent-%COMP%]   span[_ngcontent-%COMP%]{font-size:16px}.total-cotizacion[_ngcontent-%COMP%]   strong[_ngcontent-%COMP%]{font-size:24px}ion-button[type=submit][_ngcontent-%COMP%]{height:48px;font-size:16px}"]})}}return r})();export{Ji as NuevaCotizacionPage};
