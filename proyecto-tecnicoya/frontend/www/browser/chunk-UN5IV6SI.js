import{a as Pe}from"./chunk-X344YWBZ.js";import{a as Te}from"./chunk-PZ6CWC4A.js";import"./chunk-LB4NNBHO.js";import{a as y}from"./chunk-WXOXMQ3X.js";import{_ as be,a as fe,da as xe,ga as Ce,i as _e,j as ge,ka as ve,pa as Ee,u as he}from"./chunk-TI2PQS3J.js";import{a as pe}from"./chunk-XRERQNEZ.js";import"./chunk-JQ3F7U5Y.js";import{A as S,Aa as j,B as a,C as n,D as c,E as F,Ea as R,F as b,G as f,Ga as L,Ha as H,Ia as Y,Ja as J,K as l,Ka as K,L as w,M as k,Ma as Q,Na as W,Oa as X,R as U,S as D,Sa as Z,Ua as ee,Ya as ie,_a as te,db as oe,eb as ne,ia as z,ib as ae,j as _,jb as re,k as O,l as x,m as C,n as I,na as P,nb as le,o as d,oa as N,pa as V,qb as ce,r as m,ra as A,s as h,sa as $,sb as se,ta as q,tb as de,va as B,w as p,wb as ue,xa as G,xb as me,y as M,z as T}from"./chunk-IBAPA63D.js";import"./chunk-XMAMLXFW.js";import"./chunk-EW67HA6M.js";import"./chunk-WXVXXLBH.js";import"./chunk-EFAAWUSX.js";import"./chunk-GLOUZK3F.js";import"./chunk-N4PXAYQ7.js";import"./chunk-4WFVMWDK.js";import"./chunk-M2X7KQLB.js";import"./chunk-2YSZFPCQ.js";import"./chunk-57YRIO75.js";import"./chunk-NMPY7VJP.js";import"./chunk-C5RQ2IC2.js";import"./chunk-42C7ZIID.js";import{h as g}from"./chunk-B4AJQJMI.js";var Se=(t,s)=>s.valor,Fe=()=>[];function we(t,s){t&1&&c(0,"ion-spinner",4)}function ye(t,s){t&1&&c(0,"ion-icon",5)}function Oe(t,s){t&1&&(a(0,"div",6),c(1,"ion-spinner",4),a(2,"p"),l(3,"Cargando datos..."),n()())}function Ie(t,s){t&1&&(a(0,"ion-note",16),l(1,"El nombre es obligatorio"),n())}function Me(t,s){t&1&&(a(0,"ion-note",16),l(1,"El apellido es obligatorio"),n())}function ke(t,s){t&1&&(a(0,"ion-note",16),l(1,"El tel\xE9fono es obligatorio"),n())}function Ue(t,s){if(t&1&&(a(0,"ion-select-option",25),l(1),n()),t&2){let e=s.$implicit;h("value",e.valor),d(),k(" ",e.etiqueta," ")}}function De(t,s){if(t&1&&(a(0,"ion-chip")(1,"ion-label"),l(2),n()()),t&2){let e=s.$implicit,i=f(3);d(2),w(i.obtenerEtiquetaEspecialidad(e))}}function ze(t,s){if(t&1&&(a(0,"div",29),c(1,"ion-icon",32),a(2,"span"),l(3),n()()),t&2){let e=f(3);d(3),w(e.ubicacionTexto)}}function Ne(t,s){t&1&&(a(0,"div",30),c(1,"ion-icon",33),a(2,"span"),l(3,"Sin ubicaci\xF3n configurada"),n()())}function Ve(t,s){t&1&&(c(0,"ion-spinner",34),l(1," Obteniendo ubicaci\xF3n... "))}function Ae(t,s){t&1&&(c(0,"ion-icon",35),l(1," Usar mi ubicaci\xF3n actual "))}function $e(t,s){if(t&1){let e=F();a(0,"ion-card")(1,"ion-card-header")(2,"ion-card-title"),c(3,"ion-icon",22),l(4," Datos Profesionales "),n()(),a(5,"ion-card-content")(6,"ion-item")(7,"ion-label",14),l(8,"Descripci\xF3n profesional"),n(),c(9,"ion-textarea",23),n(),a(10,"ion-item")(11,"ion-label",14),l(12,"Especialidades"),n(),a(13,"ion-select",24),T(14,Ue,2,2,"ion-select-option",25,Se),n()(),a(16,"div",26),T(17,De,3,1,"ion-chip",null,M),n()()(),a(19,"ion-card")(20,"ion-card-header")(21,"ion-card-title"),c(22,"ion-icon",27),l(23," Mi Ubicaci\xF3n Base "),n()(),a(24,"ion-card-content")(25,"p",28),l(26," Esta es tu ubicaci\xF3n de trabajo. Los clientes cercanos ver\xE1n tus servicios. "),n(),m(27,ze,4,1,"div",29)(28,Ne,4,0,"div",30),a(29,"ion-button",31),b("click",function(){x(e);let o=f(2);return C(o.obtenerMiUbicacion())}),m(30,Ve,2,0)(31,Ae,2,0),n()()()}if(t&2){let e,i=f(2);d(14),S(i.tiposServicio),d(3),S(((e=i.formulario.get("especialidades"))==null?null:e.value)||D(3,Fe)),d(10),p(i.ubicacionTexto?27:28),d(2),h("disabled",i.obteniendoUbicacion),d(),p(i.obteniendoUbicacion?30:31)}}function qe(t,s){t&1&&c(0,"ion-spinner",4)}function Be(t,s){t&1&&(c(0,"ion-icon",36),l(1," Guardar Cambios "))}function Ge(t,s){if(t&1){let e=F();a(0,"form",7)(1,"div",8)(2,"ion-avatar",9),b("click",function(){x(e);let o=f();return C(o.cambiarFoto())}),c(3,"img",10),n(),a(4,"ion-button",11),b("click",function(){x(e);let o=f();return C(o.cambiarFoto())}),c(5,"ion-icon",12),l(6," Cambiar Foto "),n()(),a(7,"ion-card")(8,"ion-card-header")(9,"ion-card-title"),c(10,"ion-icon",13),l(11," Informaci\xF3n Personal "),n()(),a(12,"ion-card-content")(13,"ion-item")(14,"ion-label",14),l(15,"Nombre *"),n(),c(16,"ion-input",15),n(),m(17,Ie,2,0,"ion-note",16),a(18,"ion-item")(19,"ion-label",14),l(20,"Apellido *"),n(),c(21,"ion-input",17),n(),m(22,Me,2,0,"ion-note",16),a(23,"ion-item")(24,"ion-label",14),l(25,"Tel\xE9fono *"),n(),c(26,"ion-input",18),n(),m(27,ke,2,0,"ion-note",16),a(28,"ion-item")(29,"ion-label",14),l(30,"Direcci\xF3n"),n(),c(31,"ion-input",19),n()()(),m(32,$e,32,4),a(33,"div",20)(34,"ion-button",21),b("click",function(){x(e);let o=f();return C(o.guardar())}),m(35,qe,1,0,"ion-spinner",4)(36,Be,2,0),n()()()}if(t&2){let e,i,o,r=f();h("formGroup",r.formulario),d(3),h("src",r.fotoPreview||(r.usuario.perfil==null?null:r.usuario.perfil.fotoUrl)||(r.usuario.perfil==null?null:r.usuario.perfil.fotoPerfil)||"assets/avatar-default.png",I),d(14),p((e=r.formulario.get("nombre"))!=null&&e.touched&&(!((e=r.formulario.get("nombre"))==null||e.errors==null)&&e.errors.required)?17:-1),d(5),p((i=r.formulario.get("apellido"))!=null&&i.touched&&(!((i=r.formulario.get("apellido"))==null||i.errors==null)&&i.errors.required)?22:-1),d(5),p((o=r.formulario.get("telefono"))!=null&&o.touched&&(!((o=r.formulario.get("telefono"))==null||o.errors==null)&&o.errors.required)?27:-1),d(5),p(r.esTecnico?32:-1),d(2),h("disabled",!r.formulario.valid||r.guardando),d(),p(r.guardando?35:36)}}var oi=(()=>{class t{constructor(){this.router=_(z),this.fb=_(B),this.authServicio=_(pe),this.usuariosServicio=_(Pe),this.geoServicio=_(Te),this.toastCtrl=_(ce),this.actionSheetCtrl=_(le),this.usuario=null,this.tiposServicio=y,this.fotoPreview=null,this.archivoFoto=null,this.guardando=!1,this.cargando=!0,this.obteniendoUbicacion=!1,this.ubicacionTexto="",this.coordenadasTecnico=null,fe({personOutline:ve,cameraOutline:ge,saveOutline:Ee,locationOutline:be,callOutline:_e,mailOutline:xe,closeCircle:he,navigateOutline:Ce})}ngOnInit(){this.cargarDatosUsuario()}cargarDatosUsuario(){this.cargando=!0,this.usuariosServicio.obtenerPerfil().subscribe({next:e=>{e.exito&&e.datos?(this.usuario=e.datos,this.inicializarFormulario()):(this.usuario=this.authServicio.obtenerUsuarioActual(),this.inicializarFormulario()),this.cargando=!1},error:e=>{console.error("Error al cargar perfil:",e),this.usuario=this.authServicio.obtenerUsuarioActual(),this.inicializarFormulario(),this.cargando=!1}})}get esTecnico(){return this.authServicio.esTecnico()}inicializarFormulario(){let e=this.usuario?.nombre||this.usuario?.perfil?.nombre||"",i=this.usuario?.apellido||this.usuario?.perfil?.apellido||"",o=this.usuario?.telefono||this.usuario?.perfil?.telefono||"",r=this.obtenerDireccionTexto(this.usuario?.perfil?.direccion);this.esTecnico&&this.cargarUbicacionExistente(),this.formulario=this.fb.group({nombre:[e,P.required],apellido:[i,P.required],telefono:[o,P.required],direccion:[r],descripcion:[this.usuario?.datosTecnico?.descripcion||""],especialidades:[this.usuario?.datosTecnico?.especialidades||[]]})}cargarUbicacionExistente(){let e=this.usuario?.datosTecnico?.ubicacionBase,i=e?.coordenadas;if(i?.coordinates?.length===2){let[o,r]=i.coordinates;(o!==0||r!==0)&&(this.coordenadasTecnico={latitud:r,longitud:o},this.ubicacionTexto=e?.direccion||`${r.toFixed(4)}, ${o.toFixed(4)}`)}}obtenerMiUbicacion(){return g(this,null,function*(){this.obteniendoUbicacion=!0;try{let e=yield this.geoServicio.obtenerUbicacionActual();if(e){this.coordenadasTecnico={latitud:e.latitud,longitud:e.longitud};try{let i=yield this.obtenerDireccionDesdeCoords(e.latitud,e.longitud);this.ubicacionTexto=i||`${e.latitud.toFixed(4)}, ${e.longitud.toFixed(4)}`}catch{this.ubicacionTexto=`${e.latitud.toFixed(4)}, ${e.longitud.toFixed(4)}`}yield this.mostrarToast("Ubicaci\xF3n obtenida correctamente","success")}else yield this.mostrarToast("No se pudo obtener tu ubicaci\xF3n. Verifica los permisos.","warning")}catch(e){console.error("Error obteniendo ubicaci\xF3n:",e),yield this.mostrarToast("Error al obtener ubicaci\xF3n","danger")}finally{this.obteniendoUbicacion=!1}})}obtenerDireccionDesdeCoords(e,i){return g(this,null,function*(){let o=`https://nominatim.openstreetmap.org/reverse?format=json&lat=${e}&lon=${i}&zoom=16&addressdetails=1`,r=yield fetch(o,{headers:{"User-Agent":"TecnicoYa-App"}});if(!r.ok)throw new Error("Error en geocodificaci\xF3n");let v=yield r.json(),u=v.address,E=[];return u.road&&E.push(u.road),u.suburb&&E.push(u.suburb),(u.city||u.town||u.village)&&E.push(u.city||u.town||u.village),E.join(", ")||v.display_name?.split(",").slice(0,3).join(",")})}obtenerDireccionTexto(e){if(!e)return"";if(typeof e=="string")return e;let i=[];return e.calle&&i.push(e.calle),e.ciudad&&i.push(e.ciudad),e.estado&&i.push(e.estado),i.length>0?i.join(", "):""}cambiarFoto(){return g(this,null,function*(){yield(yield this.actionSheetCtrl.create({header:"Cambiar foto de perfil",buttons:[{text:"Tomar foto",handler:()=>this.tomarFoto()},{text:"Elegir de galer\xEDa",handler:()=>this.elegirDeGaleria()},{text:"Cancelar",role:"cancel"}]})).present()})}tomarFoto(){this.elegirDeGaleria()}elegirDeGaleria(){let e=document.createElement("input");e.type="file",e.accept="image/*",e.onchange=i=>{let o=i.target.files?.[0];if(o){this.archivoFoto=o;let r=new FileReader;r.onload=v=>{this.fotoPreview=v.target.result},r.readAsDataURL(o)}},e.click()}guardar(){return g(this,null,function*(){if(!this.formulario.valid){this.formulario.markAllAsTouched();return}this.guardando=!0;let e={perfil:{nombre:this.formulario.value.nombre,apellido:this.formulario.value.apellido,telefono:this.formulario.value.telefono,direccion:{calle:this.formulario.value.direccion||""}}};this.esTecnico&&(e.datosTecnico={descripcion:this.formulario.value.descripcion,especialidades:this.formulario.value.especialidades},this.coordenadasTecnico&&(e.datosTecnico.ubicacionBase={direccion:this.ubicacionTexto,latitud:this.coordenadasTecnico.latitud,longitud:this.coordenadasTecnico.longitud})),this.usuariosServicio.actualizarPerfil(e).subscribe({next:i=>g(this,null,function*(){if(i.exito&&i.datos&&this.authServicio.actualizarUsuario(i.datos),this.archivoFoto){let o=new FormData;o.append("foto",this.archivoFoto),this.usuariosServicio.subirFotoPerfil(o).subscribe({next:()=>{console.log("Foto subida correctamente"),this.authServicio.cargarUsuario()},error:r=>{console.error("Error al subir foto:",r),this.mostrarToast("Error al subir la foto","danger")}})}this.guardando=!1,yield this.mostrarToast("Perfil actualizado correctamente","success"),this.router.navigate(["/tabs/perfil"])}),error:i=>{console.error("Error al actualizar perfil:",i),this.guardando=!1,this.mostrarToast("Error al actualizar perfil","danger")}})})}obtenerEtiquetaEspecialidad(e){return y.find(o=>o.valor===e)?.etiqueta||e}mostrarToast(e,i="primary"){return g(this,null,function*(){yield(yield this.toastCtrl.create({message:e,duration:2e3,color:i,position:"bottom"})).present()})}static{this.\u0275fac=function(i){return new(i||t)}}static{this.\u0275cmp=O({type:t,selectors:[["app-editar-perfil"]],standalone:!0,features:[U],decls:13,vars:3,consts:[["slot","start"],["defaultHref","/tabs/perfil"],["slot","end"],[3,"click","disabled"],["name","crescent"],["name","save-outline"],[1,"cargando-container"],[3,"formGroup"],[1,"foto-container"],[3,"click"],["alt","Foto",3,"src"],["fill","clear",3,"click"],["name","camera-outline","slot","start"],["name","person-outline"],["position","stacked"],["formControlName","nombre"],["color","danger",1,"error-note"],["formControlName","apellido"],["formControlName","telefono","type","tel"],["formControlName","direccion","placeholder","Tu direcci\xF3n"],[1,"ion-padding"],["expand","block",3,"click","disabled"],["name","construct-outline"],["formControlName","descripcion","placeholder","Cu\xE9ntale a tus clientes sobre ti y tu experiencia...","rows","4"],["formControlName","especialidades","multiple","true","placeholder","Selecciona tus especialidades","interface","alert"],[3,"value"],[1,"especialidades-seleccionadas"],["name","location-outline"],[1,"ubicacion-info"],[1,"ubicacion-actual"],[1,"ubicacion-actual","sin-ubicacion"],["expand","block","fill","outline",3,"click","disabled"],["name","location-outline","color","primary"],["name","location-outline","color","warning"],["name","crescent","slot","start"],["name","navigate-outline","slot","start"],["name","save-outline","slot","start"]],template:function(i,o){i&1&&(a(0,"ion-header")(1,"ion-toolbar")(2,"ion-buttons",0),c(3,"ion-back-button",1),n(),a(4,"ion-title"),l(5,"Editar Perfil"),n(),a(6,"ion-buttons",2)(7,"ion-button",3),b("click",function(){return o.guardar()}),m(8,we,1,0,"ion-spinner",4)(9,ye,1,0,"ion-icon",5),n()()()(),a(10,"ion-content"),m(11,Oe,4,0,"div",6)(12,Ge,37,8,"form",7),n()),i&2&&(d(7),h("disabled",!(o.formulario!=null&&o.formulario.valid)||o.guardando||o.cargando),d(),p(o.guardando?8:9),d(3),p(o.cargando?11:o.usuario?12:-1))},dependencies:[X,Z,re,ae,H,j,Y,J,K,Q,ee,ie,de,me,L,se,R,ne,ue,oe,W,te,G,A,N,V,$,q],styles:[".foto-container[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center;padding:32px 16px;background:linear-gradient(135deg,var(--ion-color-primary),var(--ion-color-primary-shade))}.foto-container[_ngcontent-%COMP%]   ion-avatar[_ngcontent-%COMP%]{width:120px;height:120px;border:4px solid white;box-shadow:0 4px 12px #0003;cursor:pointer}.foto-container[_ngcontent-%COMP%]   ion-button[_ngcontent-%COMP%]{margin-top:12px;--color: white}.ubicacion-info[_ngcontent-%COMP%]{color:var(--ion-color-medium);font-size:14px;margin-bottom:12px}.ubicacion-actual[_ngcontent-%COMP%]{display:flex;align-items:center;gap:8px;padding:12px;background:var(--ion-color-light);border-radius:8px;margin-bottom:12px}.ubicacion-actual[_ngcontent-%COMP%]   ion-icon[_ngcontent-%COMP%]{font-size:20px}.ubicacion-actual[_ngcontent-%COMP%]   span[_ngcontent-%COMP%]{flex:1;font-size:14px}.ubicacion-actual.sin-ubicacion[_ngcontent-%COMP%]{background:var(--ion-color-warning-tint)}.cargando-container[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center;justify-content:center;height:50vh}.cargando-container[_ngcontent-%COMP%]   ion-spinner[_ngcontent-%COMP%]{width:48px;height:48px}.cargando-container[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{margin-top:16px;color:var(--ion-color-medium)}ion-card[_ngcontent-%COMP%]{margin:16px;border-radius:12px}ion-card[_ngcontent-%COMP%]   ion-card-title[_ngcontent-%COMP%]{display:flex;align-items:center;gap:8px;font-size:18px}ion-card[_ngcontent-%COMP%]   ion-card-title[_ngcontent-%COMP%]   ion-icon[_ngcontent-%COMP%]{font-size:22px}.error-note[_ngcontent-%COMP%]{display:block;padding:4px 16px;font-size:12px}.especialidades-seleccionadas[_ngcontent-%COMP%]{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px}ion-button[expand=block][_ngcontent-%COMP%]{height:48px;font-size:16px}"]})}}return t})();export{oi as EditarPerfilPage};
