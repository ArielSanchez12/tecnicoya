import{a as b}from"./chunk-JQ3F7U5Y.js";import{b as g,c as l,ca as m,g as n,h as s,i as d,ia as p,j as h,q as f}from"./chunk-IBAPA63D.js";var c="tecnicoya_token",u="tecnicoya_usuario",x=(()=>{class r{constructor(){this.http=h(m),this.router=h(p),this.apiUrl=`${b.apiUrl}/auth`,this.usuarioSubject=new g(this.obtenerUsuarioGuardado()),this.usuario$=this.usuarioSubject.asObservable(),this.usuarioActual$=this.usuario$,this.estaAutenticado=f(this.tieneToken()),this.cargando=f(!1),this.verificarEstadoAuth()}login(t){return this.cargando.set(!0),this.http.post(`${this.apiUrl}/login`,t).pipe(s(e=>{console.log("\u{1F4E5} Respuesta del login:",e);let o=e.datos?.token||e.token,i=e.datos?.usuario||e.usuario;e.exito&&o&&i&&(console.log("\u2705 Guardando sesi\xF3n para:",i.perfil?.nombre),this.guardarSesion(o,i)),this.cargando.set(!1)}),n(e=>{throw this.cargando.set(!1),e}))}registrar(t){this.cargando.set(!0);let e={email:t.email,contrasena:t.contrasena,rol:t.rol,perfil:{nombre:t.nombre,apellido:t.apellido,telefono:t.telefono}};return this.http.post(`${this.apiUrl}/registro`,e).pipe(s(o=>{let i=o.datos?.token||o.token,a=o.datos?.usuario||o.usuario;o.exito&&i&&a&&this.guardarSesion(i,a),this.cargando.set(!1)}),n(o=>{throw this.cargando.set(!1),o}))}registrarTecnico(t){this.cargando.set(!0);let e={email:t.email,contrasena:t.contrasena,rol:"tecnico",perfil:{nombre:t.nombre,apellido:t.apellido,telefono:t.telefono},datosTecnico:{especialidades:t.especialidades||[],descripcion:t.descripcion||"",emergencia24h:!1}};return this.http.post(`${this.apiUrl}/registro`,e).pipe(s(o=>{let i=o.datos?.token||o.token,a=o.datos?.usuario||o.usuario;o.exito&&i&&a&&this.guardarSesion(i,a),this.cargando.set(!1)}),n(o=>{throw this.cargando.set(!1),o}))}logout(){localStorage.removeItem(c),localStorage.removeItem(u),this.usuarioSubject.next(null),this.estaAutenticado.set(!1),this.router.navigate(["/login"])}verificarAutenticacion(){return this.obtenerToken()?this.http.get(`${this.apiUrl}/verificar`).pipe(s(e=>{if(e.exito){let o=e.datos?.usuario||e.datos;o&&(console.log("\u2705 Usuario verificado:",o.perfil?.nombre),this.actualizarUsuario(o))}}),n(e=>(console.error("\u274C Error verificando token:",e),this.logout(),l({exito:!1,mensaje:"Token inv\xE1lido"})))):l({exito:!1,mensaje:"No hay token"})}obtenerToken(){return localStorage.getItem(c)}obtenerUsuario(){return this.usuarioSubject.getValue()}obtenerUsuarioActual(){return this.obtenerUsuario()}obtenerRolUsuario(){return this.obtenerUsuario()?.rol||null}esTecnico(){return this.obtenerRolUsuario()==="tecnico"}esCliente(){return this.obtenerRolUsuario()==="cliente"}actualizarUsuario(t){localStorage.setItem(u,JSON.stringify(t)),this.usuarioSubject.next(t)}cargarUsuario(){return this.verificarAutenticacion()}guardarSesion(t,e){localStorage.setItem(c,t),localStorage.setItem(u,JSON.stringify(e)),this.usuarioSubject.next(e),this.estaAutenticado.set(!0)}tieneToken(){return!!localStorage.getItem(c)}obtenerUsuarioGuardado(){let t=localStorage.getItem(u);if(t)try{return JSON.parse(t)}catch{return null}return null}verificarEstadoAuth(){this.tieneToken()&&this.verificarAutenticacion().subscribe()}static{this.\u0275fac=function(e){return new(e||r)}}static{this.\u0275prov=d({token:r,factory:r.\u0275fac,providedIn:"root"})}}return r})();export{x as a};
